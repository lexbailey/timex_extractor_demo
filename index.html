<html>
    <head>
        <title>Timex finder</title>
        <script src="brython.js"></script>
        <script src="brython_stdlib.js"></script>
        <script type="text/python" class="webworker" id="worker" src="worker.py" pythonpath='https://danieljabailey.github.io/timex_extractor_demo/Lib'b></script>
        <style type='text/css'>
            div{
                margin-top:0;
                margin-bottom:1em;
            }
            div.output{
                height:2em;
                font-size:2em;
                border:1px solid black;
                padding-top: 0.7em;
                padding-left: 0.7em;
            }
            div.loader{
                position:relative;
                top: -3.38em;
                height:2em;
                font-size:2em;
            }
            div.methodname{
                margin-bottom:0;
                font-size:0.8em;
            }
        </style>
    </head>
    <body onload="brython({pythonpath:['https://danieljabailey.github.io/timex_extractor_demo/Lib/site-packages']})" style="font-family:sans-serif">
        <script type='text/javascript'>
            tfworker = new Worker('worker.js');
        </script>
        <script type="text/python3">
            from browser import worker as ww
            from browser import document, alert, timer, window, bind
            w = ww.Worker('worker')
            tfw = window.tfworker

            t = None
            running = False
            done = [False, False, False]
            last_toks = []

            @bind(w, "message")
            @bind(tfw, "message")
            def callback(m):
                global running
                c, *d = m.data
                if c == 'loaded':
                    document["text"].bind("input", run_soon)
                    document["text"].bind("change", run_manual)
                    document["loading_screen"].style['display'] = 'none'
                    document["content"].style['display'] = 'block'
                elif c == 'regex':
                    toks, result = d
                    show_result(result, toks, 'output1')
                    last_toks = toks
                    done[0] = True
                elif c == 'bayes':
                    toks, result = d
                    show_result(result, toks, 'output2')
                    last_toks = toks
                    done[1] = True
                elif c == 'nn':
                    toks, result = d
                    show_result(result, toks, 'output3')
                    last_toks = toks
                    done[2] = True
                else:
                    print("unknown message")
                    print(c)
                    print(d)
                if all(done):
                    running = False
                    if document['text'].value.split(' ') != last_toks:
                        run_soon(None)

            def show_result(result, toks, name):
                el = document[name+'-load']
                el.style['display'] = 'none'
                el = document[name]
                el.innerHTML = ''
                el.style['opacity'] = '1'
                for tag, tok in zip(result, toks):
                    new = document.createElement('span')
                    new.innerText = tok + ' '
                    if tag == 1:
                        new.style = {'color':'#00ca00', 'font-weight':'bold'}
                    el.appendChild(new)

            def show_spinner(name):
                el = document[name+'-load']
                el.style['display'] = 'inline'

            def hide_result(name):
                el = document[name]
                el.style['opacity'] = '0.2'
                if document['auto'].checked:
                    show_spinner(name)

                

            def run():
                global running
                if running:
                    return
                running = True
                toks = document["text"].value.split(" ")
                w.send(('run', toks))
                tfw.postMessage(['run', toks])

            def run_soon(ev):
                hide_result('output1')
                hide_result('output2')
                hide_result('output3')
                if document['auto'].checked:
                    global t
                    if t is not None:
                        timer.clear_timeout(t)
                    t = timer.set_timeout(run, 700)

            def run_manual(ev):
                if not document['auto'].checked:
                    show_spinner('output1')
                    show_spinner('output2')
                    show_spinner('output3')
                    timer.set_timeout(run, 0)

            run_soon(None)
        </script>
        <div id="header" style='width:80%;margin:auto;'>
            <h1>Timex finder</h1>
            <p>A demonstration of three different methods of locating timexes in a sentence.</p>
        </div>
        <div id="loading_screen" style='width:80%;margin:auto;text-align:center'>
            <p style='font-size:3em'>Loading...</p>
            <img style='height:5em;' src='loading.gif' />
        </div>
        <div id="content" style='width:80%;margin:auto;display:none'>
            <div style='float:right;display:inline'><input id='auto' type='checkbox' name='auto' checked/><label for='auto'>Rerun automatically while typing</label></div>
            <div class="methodname">Input text:</div>
            <input id="text" autofocus style='width:100%;margin-bottom:1em;font-size:1.5em;' value='The party started five minutes ago'>
            <div class="methodname">Regular expression pattern matcher:</div>
            <div class="output" id="output1"></div>
            <div class="loader" id="output1-load" style='display:none;'><img style='height:2em;float:right' src='loading.gif' /></div>
            <div class="methodname">Naive bayes classifier:</div>
            <div class="output" id="output2"></div>
            <div class="loader" id="output2-load" style='display:none;'><img style='height:2em;float:right' src='loading.gif' /></div>
            <div class="methodname">Deep neural network:</div>
            <div class="output" id="output3"></div>
            <div class="loader" id="output3-load" style='display:none;'><img style='height:2em;float:right' src='loading.gif' /></div>
            <div>
                <h2>What is this?</h2>
                <p>It's a demo of three methods of extracting timex information from strings. All of the algorithms that do this are running in your browser. They were originally written in python, and so to avoid duplicating code (and having to potentially rewrite lots of regexes) the regex and bayes extractors run with brython (browser python, a python interpreter implemented in javascript). The deep NN model is running on tensorflowjs. The learning data came from tempeval2. The NN uses a pretrained word embedding from GloVe. Enjoy :)</p>
                <h2>Usage notes</h2>
                <p>When "Rerun automatically while typing" is disabled, press enter to rerun.</p>
                <p>Tokenisation is done by splitting on spaces, so you should prefer "Yesterday , today , and tomorrow ." over "Yesterday, today, and tomorrow."</p>
                <h2>Why doesn't it work for "&lt;some sentence&gt;"?</h2>
                <p>Short answer; because the training data was lacking.</p>
                <p>Longer answer; the bottom two algorithms are severly affected by a lack of training data. The regex based parser is not, but instead is far from perfect because it takes lots of human effort to make it good. It still outperforms the naive bayes classifier and usually keeps up with the deep nn (and in many cases is actually the only algorithm that gets everything right). The deep nn sometimes gives surprising results.</p>
            </div>
        </div>
    </body>
</html>
